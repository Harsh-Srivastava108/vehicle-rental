<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Booking</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <nav class="navbar">
    <div class="logo">Rent-A-Vehicle</div>
    <ul class="nav-links">
      <li><a href="about.html">About Developers</a></li>
      <li><a href="index.html">Home</a></li>
      <li><a href="bookings.html">Bookings</a></li>
      <li><a href="login.html">Login</a></li>
    </ul>
  </nav>
</header>

<main>
  <div class="booking-container">
    <h2 id="vehicleName"></h2>
    <img id="vehicleImage" src="" alt="Vehicle">
    <p id="vehiclePrice"></p>

    <form id="bookingForm">
      <label>Full Name:</label>
      <input type="text" name="fullname" required>

      <label>Email:</label>
      <input type="email" name="email" required>

      <label>Start Date:</label>
      <input type="date" name="startdate" required>

      <label>End Date:</label>
      <input type="date" name="enddate" required>

      <input type="hidden" id="totalPrice" name="totalPrice">


      <p id="calculatedPrice" style="font-weight:bold; color:green;"></p>

      <button type="submit">Confirm Booking</button>
    </form>
  </div>
</main>

<footer>
  <p>© 2025 Rent-A-Vehicle | Developed by Nikhil Kumar Jha & Harsh Srivastava</p>
</footer>

<script>
const API_URL = "https://vehicle-rental-vxjx.onrender.com/api";

const params = new URLSearchParams(window.location.search);
const vehicleId = params.get("vehicleId");

let selectedVehicle = null;

// ✅ Fetch vehicle details
async function loadVehicle() {
  try {
    const res = await fetch(`${API_URL}/vehicles/${vehicleId}`);
    if (!res.ok) throw new Error("Failed to fetch vehicle");
    selectedVehicle = await res.json();

    document.getElementById("vehicleName").textContent =
      `${selectedVehicle.make} ${selectedVehicle.model} (${selectedVehicle.year})`;
    document.getElementById("vehicleImage").src =
      selectedVehicle.imageUrl || "images/default.jpeg";
    document.getElementById("vehiclePrice").textContent =
      `Price: ₹${selectedVehicle.pricePerDay}/day`;
  } catch (err) {
    console.error("Error loading vehicle:", err);
    document.querySelector(".booking-container").innerHTML =
      "<p>⚠️ Failed to load vehicle details.</p>";
  }
}

// ✅ Function to calculate total price
function calculateTotalPrice() {
  const startDate = new Date(document.querySelector("[name='startdate']").value);
  const endDate = new Date(document.querySelector("[name='enddate']").value);

  if (!selectedVehicle || isNaN(startDate) || isNaN(endDate)) {
    document.getElementById("calculatedPrice").textContent = "";
    return;
  }

  const diffTime = endDate - startDate;
  const days = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
  if (days <= 0) {
    document.getElementById("calculatedPrice").textContent =
      "⚠️ End date must be after start date";
    return;
  }

  const total = days * selectedVehicle.pricePerDay;
  document.getElementById("calculatedPrice").textContent =
    `Total Price: ₹${total}`;
  return total;
}

document.querySelector("[name='startdate']").addEventListener("change", calculateTotalPrice);
document.querySelector("[name='enddate']").addEventListener("change", calculateTotalPrice);

// ✅ Handle form submit
// ✅ Handle form submit
document.getElementById("bookingForm").addEventListener("submit", async function(e) {
  e.preventDefault();

  if (!selectedVehicle) {
    alert("Vehicle details not loaded yet.");
    return;
  }

  const totalPrice = calculateTotalPrice();
  if (!totalPrice) {
    alert("Please select valid dates.");
    return;
  }

  const bookingData = {
    vehicle: selectedVehicle._id,
    userName: this.fullname.value,
    userEmail: this.email.value,
    startDate: this.startdate.value,
    endDate: this.enddate.value,
    totalPrice: totalPrice,
  };

  // ✅ Get token from localStorage
  const token = localStorage.getItem("token");
  if (!token) {
    alert("⚠️ You must be logged in to make a booking.");
    window.location.href = "login.html";
    return;
  }

  try {
    const res = await fetch(`${API_URL}/bookings`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`   // ✅ Attach token here
      },
      body: JSON.stringify(bookingData),
    });

    if (!res.ok) {
      const errorData = await res.json();
      throw new Error(errorData.message || "Booking failed");
    }

    alert(`✅ Booking confirmed for ${selectedVehicle.make} ${selectedVehicle.model}\nTotal: ₹${totalPrice}`);
    window.location.href = "bookings.html";
  } catch (err) {
    console.error("Error creating booking:", err);
    alert("❌ Failed to confirm booking. Try again.");
  }
});


// Load vehicle details
loadVehicle();
</script>
</body>
</html>
